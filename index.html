<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>محاسبه دوز شربت اطفال سافیرا</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- فونت فارسی Vazirmatn -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- فونت انگلیسی Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-color: #f5f5f5;
      --card-bg: #ffffff;
      --text-color: #212529;
      --border-color: #d0d0d0;
      --primary-color: #0d6efd;
      --primary-hover: #0b5ed7;
      --result-bg: rgba(240, 248, 255, 0.92);
      --dose-bg: rgba(255, 243, 205, 0.92);
      --note-bg: rgba(233, 236, 239, 0.92);
      --warning-color: #c00;
      --tab-bg: rgba(233, 236, 239, 0.9);
      --highlight-color: #d9480f;
    }

    body[data-theme="dark"] {
      --bg-color: #10121a;
      --card-bg: rgba(23, 26, 35, 0.98);
      --text-color: #f1f3f5;
      --border-color: #333a46;
      --primary-color: #4dabf7;
      --primary-hover: #339af0;
      --result-bg: rgba(27, 40, 56, 0.92);
      --dose-bg: rgba(44, 38, 20, 0.92);
      --note-bg: rgba(35, 40, 55, 0.95);
      --warning-color: #ff6b6b;
      --tab-bg: rgba(35, 40, 55, 0.9);
      --highlight-color: #ffd43b;
    }

    body {
      font-family: "Vazirmatn", "Inter", sans-serif;
      background: radial-gradient(circle at center, #f8fafc 0%, #e9edf5 50%, #dce2f0 100%);
      color: var(--text-color);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 8px 16px;
      transition: background 0.25s ease, color 0.25s ease;
      position: relative;
    }

    body[data-theme="dark"] {
      background: radial-gradient(circle at center, #050608 0%, #02030a 60%, #000 100%);
    }

    #sceneBg {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      display: block;
      pointer-events: none;
      z-index: 0;
      opacity: 0.26;
    }
    body[data-theme="dark"] #sceneBg {
      opacity: 0.34;
    }

    .bg-grain {
      pointer-events: none;
      position: fixed;
      inset: 0;
      mix-blend-mode: soft-light;
      opacity: 0.18;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.5'/%3E%3C/svg%3E");
      background-size: 160px 160px;
      z-index: 0;
    }
    body[data-theme="dark"] .bg-grain {
      opacity: 0.24;
    }

    .top-bar {
      width: 100%;
      max-width: 960px;
      margin-top: 10px;
      padding: 0 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
      position: relative;
      z-index: 2;
    }

    .header-area {
      display: flex;
      align-items: center;
      gap: 10px;
      text-align: right;
    }

    .top-title {
      font-size: 18px;
      font-weight: 600;
      white-space: nowrap;
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
    }

    .theme-toggle input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .theme-icon {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.08);
      transition: background 0.2s ease, transform 0.1s ease, border-color 0.2s ease;
    }

    .theme-toggle:hover .theme-icon {
      transform: translateY(-1px);
      background: rgba(0,0,0,0.08);
    }

    body[data-theme="dark"] .theme-icon {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.18);
    }

    .hero {
      position: relative;
      width: 100%;
      max-width: 1200px;
      height: 20vh;
      min-height: 120px;
      margin-top: 8px;
      z-index: 1;
      pointer-events: none;
    }

    .container {
      width: 100%;
      max-width: 960px;
      margin-top: 10px;
      background: var(--card-bg);
      padding: 20px 20px 24px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 90px);
      position: relative;
      z-index: 2;
      backdrop-filter: blur(10px);
    }

    h1 {
      font-size: 22px;
      text-align: center;
      margin: 0 0 10px;
    }

    .sub-title {
      text-align: center;
      font-size: 13px;
      opacity: 0.8;
      margin-bottom: 12px;
    }

    .warning {
      margin-top: 4px;
      margin-bottom: 15px;
      font-size: 12px;
      line-height: 1.7;
      color: var(--warning-color);
      background: rgba(255, 243, 205, 0.75);
      border-radius: 10px;
      padding: 10px;
      border: 1px solid rgba(255, 193, 7, 0.7);
    }
    body[data-theme="dark"] .warning {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255, 107, 107, 0.7);
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 14px;
      background: var(--tab-bg);
      border-radius: 999px;
      padding: 3px;
    }

    .tab-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 6px 8px;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
      color: var(--text-color);
    }

    .tab-btn.active {
      background: var(--card-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    .field {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      font-size: 14px;
    }

    input[type="number"],
    select {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      box-sizing: border-box;
      font-size: 14px;
      background: rgba(255,255,255,0.02);
      color: var(--text-color);
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    body[data-theme="dark"] input[type="number"],
    body[data-theme="dark"] select {
      background: rgba(0,0,0,0.25);
    }

    input[type="number"]::placeholder {
      color: #999;
    }

    input[type="number"]:focus,
    select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(13,110,253,0.2);
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 5px;
    }

    button {
      padding: 10px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
      border: none;
      font-family: inherit;
      transition: background 0.2s ease, transform 0.05s ease, box-shadow 0.15s ease, border-color 0.2s ease;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
      width: 100%;
      box-shadow: 0 6px 15px rgba(13,110,253,0.25);
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      box-shadow: 0 8px 20px rgba(13,110,253,0.35);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(13,110,253,0.2);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border-color);
      width: 100%;
      color: var(--text-color);
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: rgba(0,0,0,0.03);
    }

    body[data-theme="dark"] .btn-secondary:hover {
      background: rgba(255,255,255,0.04);
    }

    .result-box,
    .dose-box,
    .note-box {
      border-radius: 12px;
      font-size: 14px;
    }

    .result-box {
      margin-top: 20px;
      padding: 12px;
      background: var(--result-bg);
      line-height: 1.8;
      color: var(--text-color);
    }

    .dose-box {
      margin-top: 10px;
      padding: 10px;
      background: var(--dose-bg);
      color: var(--text-color);
    }

    .note-box {
      margin-top: 10px;
      padding: 10px;
      background: var(--note-bg);
      white-space: pre-line;
      color: var(--text-color);
    }

    .highlight-dose {
      color: var(--highlight-color);
      font-weight: 700;
    }

    .footer {
      margin-top: auto;
      text-align: center;
      font-size: 13px;
      opacity: 0.9;
      padding-top: 12px;
      border-top: 1px dashed rgba(0,0,0,0.12);
    }

    body[data-theme="dark"] .footer {
      border-top-color: rgba(255,255,255,0.18);
    }

    .footer a {
      text-decoration: none;
      font-weight: 600;
      color: var(--primary-color);
    }

    .footer a:hover {
      text-decoration: underline;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 600px) {
      .top-bar {
        flex-direction: row;
        align-items: center;
      }
      .header-area {
        max-width: 70%;
      }
      .top-title {
        font-size: 16px;
      }
      .container {
        margin-top: 8px;
        padding: 16px 14px 20px;
        border-radius: 14px;
        min-height: auto;
      }
      h1 {
        font-size: 18px;
      }
      .sub-title {
        font-size: 12px;
      }
      label,
      input[type="number"],
      select,
      button {
        font-size: 13px;
      }
      .btn-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- پس‌زمینه‌ی کلی افکت حروف -->
  <canvas id="sceneBg"></canvas>
  <div class="bg-grain"></div>

  <!-- نوار بالا -->
  <div class="top-bar">
    <div class="header-area">
      <div class="top-title">محاسبه دوز شربت اطفال سافیرا</div>
    </div>
    <label class="theme-toggle" title="تغییر حالت روز / شب">
      <input type="checkbox" id="themeSwitch" />
      <span id="themeIcon" class="theme-icon" aria-hidden="true">☀️</span>
    </label>
  </div>

  <!-- ناحیه‌ی خالی برای تشکیل کلمه Saphira -->
  <div class="hero"></div>

  <!-- کارت اصلی -->
  <div class="container">
    <h1>محاسبه دوز شربت اطفال سافیرا</h1>
    <div class="sub-title">
      محاسبه حجم مصرفی شربت‌های رایج در بیماری‌های کودکان
    </div>

    <div class="warning">
      این نرم‌افزار تنها یک ابزار کمک‌آموزشی و کمکی برای محاسبهٔ عددی دوز است و به‌هیچ‌وجه جایگزین معاینه و تصمیم‌گیری پزشک یا داروساز مسئول درمان بیمار نمی‌شود. استفاده از این محاسبات باید همواره با رفرنس‌های معتبر و قضاوت بالینی تطبیق داده شود.
    </div>

    <!-- تب‌ها -->
    <div class="tabs">
      <button id="tabWeight" class="tab-btn active">محاسبه بر اساس وزن</button>
      <button id="tabAge" class="tab-btn">آنتی‌هیستامین سن‌محور</button>
    </div>

    <!-- حالت وزن‌محور -->
    <div id="weightMode">
      <div class="field">
        <label for="drugSelect">انتخاب دارو</label>
        <select id="drugSelect">
          <option value="">-- دارو را انتخاب کنید --</option>
        </select>
      </div>

      <div class="field">
        <label for="weight">وزن کودک (کیلوگرم)</label>
        <input type="number" id="weight" min="0" step="0.1" placeholder="مثلاً ۱۲٫۵ کیلوگرم" />
      </div>

      <div id="drugNotesWrapper" class="field hidden">
        <label>نکات مهم دارویی</label>
        <div id="drugNotes" class="note-box"></div>
      </div>

      <div id="strengthWrapper" class="field hidden">
        <label for="strengthSelect">غلظت شربت (میلی‌گرم در ۵ میلی‌لیتر)</label>
        <select id="strengthSelect"></select>
      </div>

      <div id="diseaseWrapper" class="field hidden">
        <label for="diseaseSelect">بیماری / اندیکاسیون</label>
        <select id="diseaseSelect"></select>
      </div>

      <div id="doseInfoWrapper" class="field hidden">
        <label>دوز مورد استفاده بر اساس بیماری</label>
        <div id="doseInfo" class="dose-box"></div>
      </div>

      <div class="field btn-row">
        <button id="calcBtn" class="btn-primary">محاسبه دوز</button>
        <button id="resetBtn" type="button" class="btn-secondary">شروع مجدد</button>
      </div>

      <div id="result" class="result-box hidden"></div>
    </div>

    <!-- حالت آنتی‌هیستامین سن‌محور -->
    <div id="ageMode" class="hidden">
      <div class="field">
        <label for="ageDrugSelect">انتخاب آنتی‌هیستامین سن‌محور</label>
        <select id="ageDrugSelect">
          <option value="">-- دارو را انتخاب کنید --</option>
        </select>
      </div>

      <div class="field">
        <label for="ageYears">سن کودک (سال)</label>
        <input type="number" id="ageYears" min="0" step="0.1" placeholder="مثلاً ۳٫۵ سال" />
      </div>

      <div id="ageDrugNotesWrapper" class="field hidden">
        <label>نکات مهم دارویی</label>
        <div id="ageDrugNotes" class="note-box"></div>
      </div>

      <div id="ageStrengthWrapper" class="field hidden">
        <label for="ageStrengthSelect">غلظت شربت (میلی‌گرم در ۵ میلی‌لیتر)</label>
        <select id="ageStrengthSelect"></select>
      </div>

      <div id="ageDoseInfoWrapper" class="field hidden">
        <label>دوز بر اساس سن</label>
        <div id="ageDoseInfo" class="dose-box"></div>
      </div>

      <div class="field btn-row">
        <button id="ageCalcBtn" class="btn-primary">محاسبه دوز</button>
      </div>

      <div id="ageResult" class="result-box hidden"></div>
    </div>

    <div class="footer">
      ارتباط از طریق تلگرام:
      <a href="https://t.me/reza0rbz" target="_blank">@reza0rbz</a>
    </div>
  </div>

  <script>
    /************************************************************
     * تبدیل اعداد به فارسی
     ************************************************************/
    const persianDigitsMap = {
      '0': '۰',
      '1': '۱',
      '2': '۲',
      '3': '۳',
      '4': '۴',
      '5': '۵',
      '6': '۶',
      '7': '۷',
      '8': '۸',
      '9': '۹'
    };
    function toPersianDigits(num) {
      return num.toString().replace(/[0-9]/g, d => persianDigitsMap[d]);
    }

    /************************************************************
     * دیتابیس داروهای وزن‌محور
     ************************************************************/
    const DRUGS = [
      {
        id: "acetaminophen",
        name: "Acetaminophen شربت",
        notes: `
اندیکاسیون‌های شایع:
- تب با هر علت
- درد خفیف تا متوسط (گوش، گلو، دندان، سردرد، درد پس از واکسیناسیون)

دوزینگ کودکان:
- حدود ۱۰ تا ۱۵ میلی‌گرم بر کیلوگرم در هر نوبت، هر ۴ تا ۶ ساعت در صورت نیاز.
- حداکثر معمولاً ۶۰ تا ۷۵ میلی‌گرم بر کیلوگرم در روز.

نکات کلیدی:
- می‌تواند با معدهٔ خالی یا همراه غذا مصرف شود؛ همراه غذا تحمل گوارشی را بهتر می‌کند.
- در بیماری‌های کبدی، سوء‌تغذیه، یا مصرف هم‌زمان داروهای هپاتوتوکسیک باید دوز کلی روزانه محافظه‌کارانه‌تر انتخاب شود.
- در صورت استفادهٔ هم‌زمان با ایبوپروفن، فاصلهٔ زمانی و تعداد دوزها باید واضح به والدین توضیح داده شود تا اشتباهاً دوز مضاعف داده نشود.
- شربت‌های با غلظت‌های مختلف (۱۲۰ و ۱۶۰ میلی‌گرم در ۵ میلی‌لیتر) باید برای والدین دقیقاً توضیح داده شوند تا از مصرف بیش از حد جلوگیری شود.`,
        strengths: [
          { id: "apap_120", label: "۱۲۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 120 },
          { id: "apap_160", label: "۱۶۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 160 }
        ],
        diseases: [
          {
            id: "apap_fever_pain",
            name: "تب / درد خفیف تا متوسط",
            mgPerKgPerDay: 60,
            dosesPerDay: 4,
            days: 3,
            maxMgPerKgPerDay: 75,
            extraNote: "دوز پیشنهادی بین ۱۰–۱۵ میلی‌گرم بر کیلوگرم در هر نوبت (هر ۴–۶ ساعت) معادل ۶۰ میلی‌گرم بر کیلوگرم در روز در ۴ نوبت است."
          }
        ]
      },
      {
        id: "ibuprofen",
        name: "Ibuprofen سوسپانسیون",
        notes: `
اندیکاسیون‌های شایع:
- تب وقتی پاسخ به استامینوفن ناکافی است یا جهت کاهش درد التهابی (اوتیت، دندان، گلودرد، درد عضلانی یا اسکلتی).

دوزینگ کودکان:
- حدود ۵ تا ۱۰ میلی‌گرم بر کیلوگرم در هر نوبت، هر ۶ تا ۸ ساعت (حدود ۳۰ میلی‌گرم بر کیلوگرم در روز).
- حداکثر حدود ۴۰ میلی‌گرم بر کیلوگرم در روز.

نکات کلیدی:
- بهتر است همراه غذا یا بلافاصله بعد از غذا مصرف شود تا تحریک گوارشی کمتر شود.
- در کم‌آبی، استفراغ شدید، اسهال، بیماری کلیوی، یا سابقهٔ زخم گوارشی باید با احتیاط و در برخی موارد از استامینوفن استفاده شود.
- در کودکان با سابقهٔ حساسیت به آسپرین یا سایر NSAID ها (مثلاً حملات آسم وابسته به NSAID) تجویز نشود.
- برای تب‌های طول‌کشیده باید علت زمینه‌ای بررسی شود و صرفاً تکرار دوز ایبوپروفن کافی نیست.`,
        strengths: [
          { id: "ibu_100", label: "۱۰۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 100 }
        ],
        diseases: [
          {
            id: "ibu_fever_pain",
            name: "تب / درد التهابی",
            mgPerKgPerDay: 30,
            dosesPerDay: 3,
            days: 3,
            maxMgPerKgPerDay: 40,
            extraNote: "در این محاسبه از ۳۰ میلی‌گرم بر کیلوگرم در روز در ۳ نوبت استفاده شده است."
          }
        ]
      },
      {
        id: "chlorpheniramine",
        name: "Chlorpheniramine شربت",
        notes: `
اندیکاسیون‌های شایع:
- رینیت آلرژیک و آبریزش و عطسهٔ ناشی از آلرژی یا ویروس (علامتی)
- کهیر حاد و خارش‌های آلرژیک

دوز کودک:
- حدود ۰٫۱ میلی‌گرم بر کیلوگرم در هر نوبت، هر ۴ تا ۶ ساعت (مجموعاً حدود ۰٫۴ میلی‌گرم بر کیلوگرم در روز).
- دوز روزانه بسته به سن و وزن معمولاً تا حداکثر ۶ تا ۱۲ میلی‌گرم در روز محدود می‌شود.

نکات کلیدی:
- آنتی‌هیستامین نسل اول است؛ خواب‌آلودگی، کاهش تمرکز و در کودکان کوچک‌تر، بی‌قراری و تحریک‌پذیری پارادوکسیک ایجاد می‌کند.
- در آسم کنترل‌نشده، گلوکوم زاویه بسته و احتباس ادرار باید با احتیاط مصرف شود.
- برای استفادهٔ مزمن در آلرژی‌های طولانی، معمولاً نسل دوم آنتی‌هیستامین‌ها (Cetirizine، Loratadine، Fexofenadine) انتخاب‌های مناسب‌تری هستند.
- بسیاری از شربت‌های سرماخوردگی آماده حاوی کلرفنیرآمین هستند؛ به والدین هشدار دهید که دوزها جمع نشوند.`,
        strengths: [
          { id: "cpn_2", label: "۲ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 2 }
        ],
        diseases: [
          {
            id: "cpn_allergy",
            name: "رینیت آلرژیک / کهیر حاد",
            mgPerKgPerDay: 0.4,
            dosesPerDay: 4,
            days: 5,
            maxMgPerKgPerDay: 0.4,
            extraNote: "دوز پیشنهادی مجموعاً ۰٫۴ میلی‌گرم بر کیلوگرم در روز (۰٫۱ میلی‌گرم بر کیلوگرم در هر نوبت در ۴ نوبت) است."
          }
        ]
      },
      {
        id: "diphenhydramine",
        name: "Diphenhydramine شربت",
        notes: `
اندیکاسیون‌ها:
- آلرژی حاد و کهیر
- واکنش‌های آلرژیک خفیف پوستی و مخاطی

دوز کودک:
- حدود ۱ میلی‌گرم بر کیلوگرم در هر نوبت، هر ۶ ساعت.
- حداکثر حدود ۵ میلی‌گرم بر کیلوگرم در روز یا حداکثر مطلق ۱۵۰ میلی‌گرم در روز (هرکدام که کمتر باشد).

نکات کلیدی:
- خواب‌آور قوی است و روی هوشیاری و عملکرد روان‌حرکتی اثر می‌گذارد.
- در کودکان خردسال ممکن است بی‌قراری و تحریک‌پذیری پارادوکسیک ایجاد کند.
- برای درمان مزمن آلرژی مناسب نیست و برای آن موارد از نسل دوم آنتی‌هیستامین‌ها استفاده شود.
- در کودکان زیر ۲ سال باید فقط با تجویز و پایش متخصص استفاده شود.`,
        strengths: [
          { id: "dph_12_5", label: "۱۲٫۵ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 12.5 }
        ],
        diseases: [
          {
            id: "dph_allergy",
            name: "آلرژی حاد / کهیر",
            mgPerKgPerDay: 4,
            dosesPerDay: 4,
            days: 3,
            maxMgPerKgPerDay: 5,
            extraNote: "این محاسبه بر اساس ۴ میلی‌گرم بر کیلوگرم در روز (۱ میلی‌گرم بر کیلوگرم در هر نوبت) است؛ حداکثر مجاز حدود ۵ میلی‌گرم بر کیلوگرم در روز."
          }
        ]
      },
      {
        id: "amoxicillin",
        name: "Amoxicillin شربت",
        notes: `
اندیکاسیون‌های شایع:
- اوتیت میانی حاد (AOM)
- فارنژیت استرپتوکوکی
- سینوزیت باکتریال
- پنومونی اکتسابی جامعه (CAP) خفیف تا متوسط
- برخی عفونت‌های ادراری و عفونت‌های دندانی

دوزینگ:
- عفونت خفیف تا متوسط: حدود ۴۰ تا ۴۵ میلی‌گرم بر کیلوگرم در روز در ۲ یا ۳ نوبت.
- AOM، سینوزیت یا CAP مقاوم: ۸۰ تا ۹۰ میلی‌گرم بر کیلوگرم در روز (معمولاً در دو نوبت).

نکات کلیدی:
- می‌تواند با غذا یا بدون غذا مصرف شود، ولی همراه غذا تحمل گوارشی را بهتر می‌کند.
- در بیماران با سابقهٔ حساسیت شدید به پنی‌سیلین باید از آموکسی‌سیلین و سایر بتالاکتام‌ها اجتناب شود.
- در زمینهٔ عفونت ویروسی مانند مونونوکلئوز عفونی، مصرف آموکسی‌سیلین می‌تواند راش ماکولوپاپولر ایجاد کند که الزاماً به معنای آلرژی حقیقی نیست.
- شربت قبل از هر نوبت باید به‌خوبی تکان داده شود و دورهٔ نگهداری آن پس از تهیه (معمولاً در یخچال) رعایت شود.`,
        strengths: [
          { id: "amox_125", label: "۱۲۵ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 125 },
          { id: "amox_250", label: "۲۵۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 250 },
          { id: "amox_200", label: "۲۰۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 200 },
          { id: "amox_400", label: "۴۰۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 400 }
        ],
        diseases: [
          {
            id: "amox_mild_tds",
            name: "عفونت خفیف – سه بار در روز (tds)",
            mgPerKgPerDay: 45,
            dosesPerDay: 3,
            days: 7,
            extraNote: "۴۵ میلی‌گرم بر کیلوگرم در روز در ۳ نوبت (۱۵ میلی‌گرم بر کیلوگرم در هر نوبت)."
          },
          {
            id: "amox_mild_bd",
            name: "عفونت خفیف – دو بار در روز (bd)",
            mgPerKgPerDay: 45,
            dosesPerDay: 2,
            days: 7,
            extraNote: "۴۵ میلی‌گرم بر کیلوگرم در روز در ۲ نوبت (۲۲٫۵ میلی‌گرم بر کیلوگرم در هر نوبت)."
          },
          {
            id: "amox_highdose_bd",
            name: "AOM / سینوزیت / CAP – دوز بالا (bd)",
            mgPerKgPerDay: 90,
            dosesPerDay: 2,
            days: 10,
            extraNote: "۹۰ میلی‌گرم بر کیلوگرم در روز در ۲ نوبت (۴۵ میلی‌گرم بر کیلوگرم در هر نوبت) جهت پوشش پنوموکوک مقاوم."
          }
        ]
      },
      {
        id: "amoxiclav",
        name: "Amoxicillin/Clavulanate شربت (Co-amoxiclav)",
        notes: `
اندیکاسیون‌ها:
- اوتیت میانی حاد یا سینوزیت که به آموکسی‌سیلین ساده پاسخ نداده یا مظنون به تولید بتالاکتاماز است
- عفونت‌های تنفسی تحتانی با احتمال زیاد باکتری‌های تولیدکنندهٔ بتالاکتاماز
- عفونت‌های پوست و بافت نرم

دوز بر اساس جزء آموکسی‌سیلین:
- معمول: حدود ۴۰ تا ۴۵ میلی‌گرم بر کیلوگرم در روز
- اوتیت/سینوزیت مقاوم: ۸۰ تا ۹۰ میلی‌گرم بر کیلوگرم در روز

نکات کلیدی:
- حتماً همراه غذا مصرف شود تا تهوع و اسهال کمتر شود و جذب بهتر گردد.
- در بیمارانی که سابقهٔ هپاتیت کولستاتیک ناشی از این دارو دارند نباید دوباره تجویز شود.
- اسهال، دل‌درد و گاهی کاندیدا دهانی یا پوشکی ممکن است رخ دهد.
- در صورت امکان، برای عفونت‌های ساده ترجیح داده می‌شود از آنتی‌بیوتیک‌های با طیف باریک‌تر استفاده شود و این دارو را برای مواردی که نیاز به پوشش بتالاکتاماز است حفظ کرد.`,
        strengths: [
          { id: "amcl_156", label: "۱۵۶ (۱۲۵/۳۱٫۲۵) میلی‌گرم در ۵ میلی‌لیتر – دوز بر اساس ۱۲۵ میلی‌گرم آموکسی‌سیلین", mgPer5ml: 125 },
          { id: "amcl_228", label: "۲۲۸ (۲۰۰/۲۸٫۵) میلی‌گرم در ۵ میلی‌لیتر – دوز بر اساس ۲۰۰ میلی‌گرم آموکسی‌سیلین", mgPer5ml: 200 },
          { id: "amcl_312", label: "۳۱۲ (۲۵۰/۶۲٫۵) میلی‌گرم در ۵ میلی‌لیتر – دوز بر اساس ۲۵۰ میلی‌گرم آموکسی‌سیلین", mgPer5ml: 250 },
          { id: "amcl_457", label: "۴۵۷ (۴۰۰/۵۷) میلی‌گرم در ۵ میلی‌لیتر – دوز بر اساس ۴۰۰ میلی‌گرم آموکسی‌سیلین", mgPer5ml: 400 },
          { id: "amcl_643", label: "۶۴۳ (۶۰۰/۴۲٫۹) میلی‌گرم در ۵ میلی‌لیتر – دوز بر اساس ۶۰۰ میلی‌گرم آموکسی‌سیلین", mgPer5ml: 600 }
        ],
        diseases: [
          {
            id: "amcl_mild_tds",
            name: "عفونت تنفسی / پوستی خفیف–متوسط – سه بار در روز",
            mgPerKgPerDay: 45,
            dosesPerDay: 3,
            days: 7,
            extraNote: "۴۵ میلی‌گرم بر کیلوگرم در روز بر اساس جزء آموکسی‌سیلین در ۳ نوبت."
          },
          {
            id: "amcl_mild_bd",
            name: "عفونت تنفسی / پوستی خفیف–متوسط – دو بار در روز",
            mgPerKgPerDay: 45,
            dosesPerDay: 2,
            days: 7,
            extraNote: "۴۵ میلی‌گرم بر کیلوگرم در روز در ۲ نوبت."
          },
          {
            id: "amcl_highdose_bd",
            name: "AOM / سینوزیت باکتریال – دوز بالا",
            mgPerKgPerDay: 90,
            dosesPerDay: 2,
            days: 10,
            extraNote: "۹۰ میلی‌گرم بر کیلوگرم در روز برای موارد مقاوم."
          }
        ]
      },
      {
        id: "cephalexin",
        name: "Cephalexin شربت",
        notes: `
اندیکاسیون‌های شایع:
- عفونت‌های پوست و بافت نرم ناشی از استافیلوکوک و استرپتوکوک (مانند امپتیگو و سلولیت)
- عفونت‌های ادراری خفیف
- برخی عفونت‌های تنفسی خفیف
- فارنژیت استرپتوکوکی (در عدم تحمل پنی‌سیلین غیرآنافیلاکسی)

دوزینگ:
- حدود ۲۵ تا ۵۰ میلی‌گرم بر کیلوگرم در روز، در ۲ تا ۴ نوبت.
- در عفونت‌های شدید پوستی می‌توان تا ۷۵ تا ۱۰۰ میلی‌گرم بر کیلوگرم در روز تجویز کرد.

نکات کلیدی:
- نسبت به آموکسی‌سیلین پوشش بهتری بر MSSA دارد و در عفونت‌های پوستی انتخاب خوبی است.
- در بیماران با سابقهٔ آنافیلاکسی به پنی‌سیلین باید با احتیاط استفاده شود یا به سمت ماکرولیدها/کلیندامایسین رفت.
- مصرف می‌تواند با غذا یا بدون غذا باشد؛ در صورت ناراحتی گوارشی بهتر است همراه غذا مصرف شود.
- نیاز به چند نوبت در روز ممکن است پیروی از درمان را کاهش دهد.`,
        strengths: [
          { id: "ceph_125", label: "۱۲۵ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 125 },
          { id: "ceph_250", label: "۲۵۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 250 }
        ],
        diseases: [
          {
            id: "ceph_mild",
            name: "UTI خفیف / فارنژیت / SSTI خفیف",
            mgPerKgPerDay: 40,
            dosesPerDay: 3,
            days: 7,
            extraNote: "بین ۲۵–۵۰ میلی‌گرم بر کیلوگرم در روز در نظر گرفته می‌شود."
          },
          {
            id: "ceph_severe",
            name: "SSTI شدید",
            mgPerKgPerDay: 80,
            dosesPerDay: 4,
            days: 10,
            extraNote: "برای عفونت‌های شدید پوستی تا ۸۰–۱۰۰ میلی‌گرم بر کیلوگرم در روز در ۴ نوبت."
          }
        ]
      },
      {
        id: "cefixime",
        name: "Cefixime سوسپانسیون",
        notes: `
اندیکاسیون‌ها:
- عفونت‌های ادراری (به‌خصوص UTI غیر پیچیده)
- اوتیت میانی
- سینوزیت
- برخی موارد CAP خفیف

دوزینگ:
- حدود ۸ میلی‌گرم بر کیلوگرم در روز، یک‌بار در روز یا ۴ میلی‌گرم بر کیلوگرم هر ۱۲ ساعت.

نکات کلیدی:
- نیمه‌عمر نسبتا طولانی دارد و می‌توان یک‌بار در روز مصرف کرد که پایبندی را بهبود می‌دهد.
- پوشش روی MSSA ضعیف‌تر از Cephalexin است و برای عفونت‌های پوستی انتخاب اول نیست.
- می‌تواند همراه یا بدون غذا مصرف شود؛ ناراحتی گوارشی (اسهال) ممکن است رخ دهد.
- در UTI های غیر پیچیده کودکان انتخابی پرکاربرد است، اما مقاومت‌های محلی باید بررسی شود.`,
        strengths: [
          { id: "cefi_100", label: "۱۰۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 100 }
        ],
        diseases: [
          {
            id: "cefi_uti",
            name: "UTI / AOM / سینوزیت / CAP – رژیم یک‌بار در روز",
            mgPerKgPerDay: 8,
            dosesPerDay: 1,
            days: 7,
            extraNote: "۸ میلی‌گرم بر کیلوگرم در روز در یک‌بار."
          },
          {
            id: "cefi_uti_bd",
            name: "UTI / AOM / سینوزیت / CAP – رژیم دو بار در روز",
            mgPerKgPerDay: 8,
            dosesPerDay: 2,
            days: 7,
            extraNote: "مجموع روزانه ۸ میلی‌گرم بر کیلوگرم در دو نوبت (هر نوبت حدود ۴ میلی‌گرم بر کیلوگرم)."
          }
        ]
      },
      {
        id: "cefuroxime",
        name: "Cefuroxime سوسپانسیون",
        notes: `
اندیکاسیون‌ها:
- اوتیت میانی حاد (AOM)
- سینوزیت باکتریال
- CAP خفیف تا متوسط
- عفونت‌های پوست و بافت نرم

دوز:
- حدود ۲۰ تا ۳۰ میلی‌گرم بر کیلوگرم در روز، تقسیم در دو نوبت (هر ۱۲ ساعت).

نکات کلیدی:
- جذب خوراکی با غذا بهتر است؛ توصیه می‌شود همراه غذا مصرف شود.
- طعم شربت برخی برندها ممکن است ناخوشایند باشد و لازم است به والدین توضیح داده شود.
- طیف پوشش آن از Cephalexin و Amoxicillin گسترده‌تر است؛ بهتر است برای مواردی که واقعاً نیاز است استفاده شود.
- می‌تواند جایگزین برای Amoxiclav در برخی عفونت‌های تنفسی باشد، به‌خصوص اگر تحمل گوارشی Amoxiclav کم باشد.`,
        strengths: [
          { id: "cefu_125", label: "۱۲۵ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 125 },
          { id: "cefu_250", label: "۲۵۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 250 }
        ],
        diseases: [
          {
            id: "cefu_respiratory",
            name: "AOM / سینوزیت / CAP / SSTI",
            mgPerKgPerDay: 25,
            dosesPerDay: 2,
            days: 7,
            extraNote: "میانگین ۲۰–۳۰ میلی‌گرم بر کیلوگرم در روز، در ۲ نوبت."
          }
        ]
      },
      {
        id: "azithromycin",
        name: "Azithromycin سوسپانسیون",
        notes: `
اندیکاسیون‌ها:
- فارنژیت یا تونسیلیت در کودکان با حساسیت شدید به بتالاکتام‌ها
- اوتیت میانی
- پنومونی آتیپیک (Mycoplasma یا Chlamydia)
- عفونت‌های تنفسی فوقانی و تحتانی خفیف در برخی شرایط

رژیم‌های متداول:
- ۱۰ میلی‌گرم بر کیلوگرم در روز برای ۳ روز
- یا ۵ روزه: روز اول ۱۰ میلی‌گرم بر کیلوگرم و روزهای ۲ تا ۵، ۵ میلی‌گرم بر کیلوگرم

نکات کلیدی:
- نیمه‌عمر طولانی دارد و پس از قطع دارو چند روز در بدن باقی می‌ماند.
- برای درمان فارنژیت استرپتوکوکی خط اول نیست و معمولاً در حساسیت شدید به پنی‌سیلین استفاده می‌شود.
- ناراحتی گوارشی (تهوع، درد شکم، اسهال) نسبتا شایع است؛ می‌توان همراه غذا مصرف کرد.
- می‌تواند فاصلهٔ QT را طولانی کند؛ در بیماران با زمینهٔ قلبی یا مصرف داروهای طولانی‌کنندهٔ QT احتیاط شود.`,
        strengths: [
          { id: "azi_200", label: "۲۰۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 200 },
          { id: "azi_100", label: "۱۰۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 100 }
        ],
        diseases: [
          {
            id: "azi_3day",
            name: "رژیم ۳ روزه",
            mgPerKgPerDay: 10,
            dosesPerDay: 1,
            days: 3,
            extraNote: "۱۰ میلی‌گرم بر کیلوگرم در روز به مدت ۳ روز."
          },
          {
            id: "azi_5day",
            name: "رژیم ۵ روزه",
            mgPerKgPerDay: 10,
            dosesPerDay: 1,
            days: 5,
            extraNote: "روز اول ۱۰ میلی‌گرم بر کیلوگرم؛ روزهای ۲ تا ۵، ۵ میلی‌گرم بر کیلوگرم. در نتیجه دوز روز اول و بقیهٔ روزها جداگانه نمایش داده می‌شود."
          }
        ]
      },
      {
        id: "clarithromycin",
        name: "Clarithromycin سوسپانسیون",
        notes: `
اندیکاسیون‌ها:
- عفونت‌های تنفسی فوقانی و تحتانی
- بخشی از رژیم درمان H. pylori
- به عنوان جایگزین در آلرژی به پنی‌سیلین (غیرآنافیلاکسی یا بنا به تصمیم پزشک)

دوز:
- حدود ۱۵ میلی‌گرم بر کیلوگرم در روز، تقسیم در دو نوبت.

نکات کلیدی:
- بهتر است همراه غذا مصرف شود تا تحمل گوارشی بهتر باشد.
- طعم فلزی دهان و تهوع می‌تواند رخ دهد؛ توضیح این نکته به والدین کمک می‌کند.
- مهارکنندهٔ مهم CYP3A4 است و در مصرف با داروهای دیگر باید تداخلات بررسی شود.
- نسبت به Azithromycin طیف مشابه دارد ولی دفعات مصرف و تداخلات بیشتر است؛ در انتخاب نهایی باید شرایط بیمار در نظر گرفته شود.`,
        strengths: [
          { id: "clar_125", label: "۱۲۵ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 125 },
          { id: "clar_250", label: "۲۵۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 250 }
        ],
        diseases: [
          {
            id: "clar_respiratory",
            name: "عفونت تنفسی فوقانی / تحتانی",
            mgPerKgPerDay: 15,
            dosesPerDay: 2,
            days: 10,
            extraNote: "۱۵ میلی‌گرم بر کیلوگرم در روز، در دو نوبت به مدت حدود ۷ تا ۱۰ روز."
          }
        ]
      },
      {
        id: "tmpsmx",
        name: "Co-trimoxazole (TMP–SMX) شربت",
        notes: `
اندیکاسیون‌ها:
- عفونت‌های ادراری
- برخی SSTI ها (از جمله بعضی MRSA های جامعه‌بنیاد)
- پروفیلاکسی یا درمان Pneumocystis jirovecii در بیماران خاص

دوز بر اساس جزء Trimethoprim (TMP):
- حدود ۸ میلی‌گرم TMP به ازای هر کیلوگرم در روز، تقسیم در دو نوبت.

نکات کلیدی:
- دوز بر اساس جزء Trimethoprim محاسبه می‌شود؛ روی برچسب شربت نسبت TMP/SMX (مثلاً ۴۰/۲۰۰) ذکر می‌شود.
- در بیماران با سابقهٔ حساسیت به سولفونامیدها یا بثورات شدید پوستی مثل سندرم استیونس-جانسون نباید استفاده شود.
- می‌تواند باعث افزایش پتاسیم شود، مخصوصاً در مصرف طولانی یا همراه با داروهای دیگر که پتاسیم را بالا می‌برند.
- حساسیت به نور و اختلالات خونی از عوارضی هستند که در مصرف طولانی باید مد نظر باشد.
- در شیرخواران خیلی کوچک و اواخر بارداری به‌دلیل خطر تئوریک کرنیکتروس باید با احتیاط جدی یا منع مصرف روبه‌رو باشد.`,
        strengths: [
          { id: "tmp_40", label: "۴۰ میلی‌گرم TMP در ۵ میلی‌لیتر (فرمول ۴۰/۲۰۰)", mgPer5ml: 40 }
        ],
        diseases: [
          {
            id: "tmp_uti",
            name: "UTI / SSTI خفیف",
            mgPerKgPerDay: 8,
            dosesPerDay: 2,
            days: 10,
            extraNote: "دوز بر اساس جزء TMP و حدود ۸ میلی‌گرم بر کیلوگرم در روز در ۲ نوبت است."
          }
        ]
      },
      {
        id: "clindamycin",
        name: "Clindamycin سوسپانسیون",
        notes: `
اندیکاسیون‌ها:
- SSTI (با شک به MRSA جامعه‌ای)، عفونت‌های دندانی، فارنژیت استرپتوکوکی در حساسیت شدید به بتالاکتام

دوز:
- حدود ۲۰ تا ۴۰ میلی‌گرم بر کیلوگرم در روز، تقسیم هر ۶ تا ۸ ساعت (۳ یا ۴ نوبت).

نکات کلیدی:
- مهم‌ترین عارضه خطر کولیت ناشی از Clostridioides difficile است؛ در صورت اسهال شدید یا خون‌دار، مدفوع خونی یا درد شکمی باید به سرعت ارزیابی شود.
- بهتر است همراه یک لیوان آب مصرف شود و کودک تا چند دقیقه بعد نخوابد تا التهاب مری کاهش یابد.
- تهوع و طعم ناخوشایند دهانی نسبتاً شایع است و باید به والدین توضیح داده شود.
- در عفونت‌های دندانی و برخی SSTI های مقاوم یا در بیماران با آلرژی شدید به بتالاکتام، داروی مهمی است.`,
        strengths: [
          { id: "clin_75", label: "۷۵ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 75 }
        ],
        diseases: [
          {
            id: "clin_ssti",
            name: "SSTI / عفونت دندانی / فارنژیت",
            mgPerKgPerDay: 30,
            dosesPerDay: 3,
            days: 10,
            maxMgPerKgPerDay: 40,
            extraNote: "در محدوده ۲۰–۴۰ میلی‌گرم بر کیلوگرم در روز، در ۳ نوبت."
          }
        ]
      },
      {
        id: "metronidazole",
        name: "Metronidazole شربت",
        notes: `
اندیکاسیون‌ها:
- ژیاردیازیس
- آمیبیاز روده‌ای
- عفونت‌های بی‌هوازی گوارشی یا دهانی
- به صورت ترکیبی در بعضی عفونت‌های شکمی

دوز:
- حدود ۳۰ تا ۵۰ میلی‌گرم بر کیلوگرم در روز، تقسیم هر ۸ ساعت

نکات کلیدی:
- بهتر است همراه غذا مصرف شود تا تهوع و درد شکم کمتر شود.
- می‌تواند طعم فلزی دهان ایجاد کند و رنگ ادرار را تیره‌تر کند که معمولاً بی‌خطر است.
- نباید همراه الکل استفاده شود، زیرا باعث واکنش شبه دی‌سولفیرام (تهوع شدید، گرگرفتگی، افت فشار) می‌شود.
- در صورت بروز علائم عصبی (بی‌حسی، گزگز دست و پا) در مصرف طولانی‌مدت باید ارزیابی انجام شود.`,
        strengths: [
          { id: "metro_125", label: "۱۲۵ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 125 }
        ],
        diseases: [
          {
            id: "metro_gi",
            name: "ژیاردیا / آمیبیاز / عفونت بی‌هوازی",
            mgPerKgPerDay: 40,
            dosesPerDay: 3,
            days: 7,
            maxMgPerKgPerDay: 50,
            extraNote: "در محدوده ۳۰–۵۰ میلی‌گرم بر کیلوگرم در روز، در ۳ نوبت."
          }
        ]
      },
      {
        id: "pseudoephedrine",
        name: "Pseudoephedrine شربت",
        notes: `
اندیکاسیون‌ها:
- احتقان بینی ناشی از سرماخوردگی، آلرژی یا سینوزیت
- کاهش فشار سینوس‌ها و احتقان گوش در سرماخوردگی یا اوتیت

دوز کودک:
- دوز پیشنهادی بر اساس وزن حدود ۴ میلی‌گرم بر کیلوگرم در روز است که در ۴ نوبت تقسیم می‌شود (هر ۴ تا ۶ ساعت).
- اغلب برای کودکان زیر ۴ سال توصیه نمی‌شود.

نکات کلیدی:
- یک محرک سیستم عصبی است و می‌تواند بی‌خوابی، تحریک‌پذیری، افزایش ضربان قلب و فشارخون ایجاد کند؛ بهتر است بعدازظهر یا عصر مصرف نشود.
- در کودکان با بیماری قلبی، فشارخون بالا، پرکاری تیروئید یا مصرف MAOI ها باید با احتیاط مصرف شود.
- از مصرف همزمان با سایر داروهای حاوی ضداحتقان (مانند بسیاری از شربت‌های سرماخوردگی) پرهیز شود تا دوز تجمعی زیاد نشود.
- این دارو می‌تواند موجب احتباس ادرار یا خشکی دهان شود و معمولاً برای مصرف کوتاه‌مدت استفاده می‌شود.`,
        strengths: [
          { id: "pse_30", label: "۳۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 30 },
          { id: "pse_15", label: "۱۵ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 15 }
        ],
        diseases: [
          {
            id: "pse_cold",
            name: "احتقان بینی / سینوزیت",
            mgPerKgPerDay: 4,
            dosesPerDay: 4,
            days: 5,
            maxMgPerKgPerDay: 4,
            extraNote: "۴ میلی‌گرم بر کیلوگرم در روز در ۴ نوبت (هر ۶ ساعت) – حداکثر روزانه ۱۲۰ میلی‌گرم یا ۴ میلی‌گرم بر کیلوگرم."
          }
        ]
      },
      {
        id: "phenylephrine",
        name: "Phenylephrine شربت",
        notes: `
اندیکاسیون‌ها:
- احتقان بینی و فشار سینوس در سرماخوردگی یا آلرژی

دوز کودک:
- دوز پیشنهادی وزن‌محور حدود ۱٫۵ میلی‌گرم بر کیلوگرم در روز است که در ۶ نوبت تقسیم می‌شود (هر ۴ ساعت).
- به طور متداول برای کودکان ۲ تا ۶ سال: ۲٫۵ میلی‌گرم هر ۴ ساعت؛ ۶ تا ۱۲ سال: ۵ میلی‌گرم هر ۴ ساعت؛ حداکثر روزانه حدود ۱۵ میلی‌گرم.

نکات کلیدی:
- نسبت به pseudoephedrine اثربخشی کمتری دارد زیرا دسترسی زیستی خوراکی پایینی دارد اما از نظر عوارض قلبی ایمن‌تر است.
- می‌تواند باعث افزایش فشارخون، سردرد، عصبانیت یا لرزش شود؛ در کودکان با بیماری قلبی یا فشارخون بالا باید با احتیاط مصرف شود.
- با مهارکننده‌های MAO و برخی داروهای فشارخون تداخل دارد؛ استفاده همزمان ممنوع است.
- از مصرف همزمان با سایر فرآورده‌های حاوی Phenylephrine یا سایر ضداحتقان‌ها اجتناب شود.`,
        strengths: [
          { id: "phe_2_5", label: "۲٫۵ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 2.5 },
          { id: "phe_5", label: "۵ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 5 }
        ],
        diseases: [
          {
            id: "phe_cold",
            name: "احتقان بینی",
            mgPerKgPerDay: 1.5,
            dosesPerDay: 6,
            days: 5,
            maxMgPerKgPerDay: 1.5,
            extraNote: "۱٫۵ میلی‌گرم بر کیلوگرم در روز در ۶ نوبت (هر ۴ ساعت) – حداکثر روزانه تقریباً ۱۵ میلی‌گرم."
          }
        ]
      }
    ];

    /************************************************************
     * دیتابیس آنتی‌هیستامین‌های سن‌محور
     ************************************************************/
    const AGE_ANTIHISTAMINES = [
      {
        id: "cetirizine",
        name: "Cetirizine (ستیریزین) شربت",
        notes: `
اندیکاسیون‌ها:
- رینیت آلرژیک فصلی یا دائمی
- کهیر مزمن ایدیوپاتیک

دوز بر اساس سن:
- ۶ ماه تا ۲ سال: حدود ۲٫۵ میلی‌گرم در روز
- ۲ تا ۶ سال: ۵ میلی‌گرم در روز
- ۶ سال و بالاتر: ۱۰ میلی‌گرم در روز

نکات کلیدی:
- نسل دوم آنتی‌هیستامین است؛ خواب‌آلودگی کمتر از نسل اول دارد اما ممکن است در برخی کودکان باعث خواب‌آلودگی شود.
- معمولاً یک‌بار در روز (ترجیحاً عصر یا قبل از خواب) مصرف می‌شود؛ در صورت خواب‌آلودگی روزانه می‌توان زمان مصرف را تغییر داد.
- در نارسایی کلیوی متوسط تا شدید، کاهش دوز یا افزایش فاصلهٔ مصرف لازم است.
- برای کنترل طولانی‌مدت کهیر مزمن طبق بسیاری از راهنماها از داروهای خط اول محسوب می‌شود.`,
        strengths: [
          { id: "ctz_5", label: "۵ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 5 }
        ],
        ageBands: [
          {
            id: "ctz_0_2",
            label: "۶ ماه تا ۲ سال",
            minAge: 0.5,
            maxAge: 2,
            mgPerDay: 2.5,
            dosesPerDay: 1,
            note: "۲٫۵ میلی‌گرم در روز (معمولاً یک‌بار در روز)."
          },
          {
            id: "ctz_2_6",
            label: "۲ تا ۶ سال",
            minAge: 2,
            maxAge: 6,
            mgPerDay: 5,
            dosesPerDay: 1,
            note: "۵ میلی‌گرم در روز (یک‌بار در روز)."
          },
          {
            id: "ctz_6plus",
            label: "۶ سال و بالاتر",
            minAge: 6,
            maxAge: 18,
            mgPerDay: 10,
            dosesPerDay: 1,
            note: "۱۰ میلی‌گرم در روز (یک‌بار در روز)."
          }
        ]
      },
      {
        id: "loratadine",
        name: "Loratadine (لوراتادین) شربت",
        notes: `
اندیکاسیون‌ها:
- رینیت آلرژیک
- کهیر مزمن

دوز بر اساس سن:
- ۲ تا ۶ سال: ۵ میلی‌گرم در روز
- ۶ سال و بالاتر: ۱۰ میلی‌گرم در روز

نکات کلیدی:
- نسل دوم آنتی‌هیستامین با خواب‌آلودگی بسیار کم است و برای مصرف روزانه مناسب است.
- معمولاً یک‌بار در روز مصرف می‌شود و برای آلرژی فصلی می‌توان به صورت روزانه در فصل آلرژی ادامه داد.
- در نارسایی کبدی باید دوز تعدیل شود و معمولاً با فواصل بیشتر تجویز می‌شود.
- از ترکیب همزمان با سایر داروهای خواب‌آور باید پرهیز شود، هرچند اثر خواب‌آوری آن ناچیز است.`,
        strengths: [
          { id: "lor_5", label: "۵ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 5 }
        ],
        ageBands: [
          {
            id: "lor_2_6",
            label: "۲ تا ۶ سال",
            minAge: 2,
            maxAge: 6,
            mgPerDay: 5,
            dosesPerDay: 1,
            note: "۵ میلی‌گرم در روز (یک‌بار در روز)."
          },
          {
            id: "lor_6plus",
            label: "۶ سال و بالاتر",
            minAge: 6,
            maxAge: 18,
            mgPerDay: 10,
            dosesPerDay: 1,
            note: "۱۰ میلی‌گرم در روز (یک‌بار در روز)."
          }
        ]
      },
      {
        id: "fexofenadine",
        name: "Fexofenadine (فکسوفنادین) شربت",
        notes: `
اندیکاسیون‌ها:
- رینیت آلرژیک
- کهیر مزمن

دوز بر اساس سن (برای شربت ۳۰ میلی‌گرم در ۵ میلی‌لیتر):
- ۲ تا ۱۱ سال: ۳۰ میلی‌گرم دو بار در روز (جمعاً ۶۰ میلی‌گرم در روز)

نکات کلیدی:
- نسل دوم آنتی‌هیستامین است و تقریباً بدون اثر خواب‌آور است زیرا عبور کمی از سد خونی-مغزی دارد.
- نباید همراه آب‌میوه‌هایی مانند گریپ‌فروت، پرتقال و سیب مصرف شود، زیرا جذب آن را کاهش می‌دهد؛ بهترین گزینه مصرف با آب ساده است.
- در کهیر مزمن می‌تواند در صورت نیاز با دوزهای بالاتر (طبق راهنماها) تنظیم شود که خارج از محدودهٔ این ماشین‌حساب است و باید توسط پزشک انجام شود.`,
        strengths: [
          { id: "fexo_30", label: "۳۰ میلی‌گرم در ۵ میلی‌لیتر", mgPer5ml: 30 }
        ],
        ageBands: [
          {
            id: "fexo_2_11",
            label: "۲ تا ۱۱ سال",
            minAge: 2,
            maxAge: 12,
            mgPerDay: 60,
            dosesPerDay: 2,
            note: "۳۰ میلی‌گرم دو بار در روز (جمعاً ۶۰ میلی‌گرم در روز)."
          }
        ]
      }
    ];

    /************************************************************
     * گرفتن المان‌ها
     ************************************************************/
    const weightMode = document.getElementById("weightMode");
    const ageMode = document.getElementById("ageMode");
    const tabWeight = document.getElementById("tabWeight");
    const tabAge = document.getElementById("tabAge");

    const weightInput = document.getElementById("weight");
    const drugSelect = document.getElementById("drugSelect");
    const strengthSelect = document.getElementById("strengthSelect");
    const diseaseSelect = document.getElementById("diseaseSelect");
    const drugNotesWrapper = document.getElementById("drugNotesWrapper");
    const drugNotes = document.getElementById("drugNotes");
    const strengthWrapper = document.getElementById("strengthWrapper");
    const diseaseWrapper = document.getElementById("diseaseWrapper");
    const doseInfoWrapper = document.getElementById("doseInfoWrapper");
    const doseInfo = document.getElementById("doseInfo");
    const resultDiv = document.getElementById("result");
    const calcBtn = document.getElementById("calcBtn");
    const resetBtn = document.getElementById("resetBtn");

    const ageDrugSelect = document.getElementById("ageDrugSelect");
    const ageYearsInput = document.getElementById("ageYears");
    const ageDrugNotesWrapper = document.getElementById("ageDrugNotesWrapper");
    const ageDrugNotes = document.getElementById("ageDrugNotes");
    const ageStrengthWrapper = document.getElementById("ageStrengthWrapper");
    const ageStrengthSelect = document.getElementById("ageStrengthSelect");
    const ageDoseInfoWrapper = document.getElementById("ageDoseInfoWrapper");
    const ageDoseInfo = document.getElementById("ageDoseInfo");
    const ageCalcBtn = document.getElementById("ageCalcBtn");
    const ageResultDiv = document.getElementById("ageResult");

    const themeSwitch = document.getElementById("themeSwitch");
    const themeIcon = document.getElementById("themeIcon");

    /************************************************************
     * توابع کمکی
     ************************************************************/
    function findDrugById(id) {
      return DRUGS.find(d => d.id === id) || null;
    }
    function findStrength(drug, strengthId) {
      return drug?.strengths?.find(s => s.id === strengthId) || null;
    }
    function findDisease(drug, diseaseId) {
      return drug?.diseases?.find(d => d.id === diseaseId) || null;
    }
    function findAgeDrugById(id) {
      return AGE_ANTIHISTAMINES.find(d => d.id === id) || null;
    }

    /************************************************************
     * پر کردن لیست‌ها
     ************************************************************/
    function populateDrugs() {
      DRUGS.forEach(drug => {
        const opt = document.createElement("option");
        opt.value = drug.id;
        opt.textContent = drug.name;
        drugSelect.appendChild(opt);
      });
    }
    function populateAgeDrugs() {
      AGE_ANTIHISTAMINES.forEach(drug => {
        const opt = document.createElement("option");
        opt.value = drug.id;
        opt.textContent = drug.name;
        ageDrugSelect.appendChild(opt);
      });
    }

    /************************************************************
     * تب‌ها
     ************************************************************/
    tabWeight.addEventListener("click", () => {
      tabWeight.classList.add("active");
      tabAge.classList.remove("active");
      weightMode.classList.remove("hidden");
      ageMode.classList.add("hidden");
    });
    tabAge.addEventListener("click", () => {
      tabAge.classList.add("active");
      tabWeight.classList.remove("active");
      ageMode.classList.remove("hidden");
      weightMode.classList.add("hidden");
    });

    /************************************************************
     * تغییر دارو (وزن‌محور)
     ************************************************************/
    drugSelect.addEventListener("change", () => {
      const drug = findDrugById(drugSelect.value);

      strengthSelect.innerHTML = "";
      diseaseSelect.innerHTML = "";
      strengthWrapper.classList.add("hidden");
      diseaseWrapper.classList.add("hidden");
      drugNotesWrapper.classList.add("hidden");
      doseInfoWrapper.classList.add("hidden");
      resultDiv.classList.add("hidden");
      drugNotes.textContent = "";
      doseInfo.innerHTML = "";
      resultDiv.innerHTML = "";

      if (!drug) return;

      drugNotes.textContent = drug.notes || "نکته‌ای ثبت نشده است.";
      drugNotesWrapper.classList.remove("hidden");

      if (drug.strengths?.length) {
        drug.strengths.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = s.label;
          strengthSelect.appendChild(opt);
        });
        strengthWrapper.classList.remove("hidden");
      }

      if (drug.diseases?.length) {
        diseaseSelect.innerHTML = '<option value="">-- بیماری / اندیکاسیون را انتخاب کنید --</option>';
        drug.diseases.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.name;
          diseaseSelect.appendChild(opt);
        });
        diseaseWrapper.classList.remove("hidden");
      }
    });

    /************************************************************
     * انتخاب بیماری (وزن‌محور)
     ************************************************************/
    diseaseSelect.addEventListener("change", () => {
      const drug = findDrugById(drugSelect.value);
      const disease = findDisease(drug, diseaseSelect.value);

      doseInfoWrapper.classList.add("hidden");
      doseInfo.innerHTML = "";

      if (!disease) return;

      const { mgPerKgPerDay, extraNote, dosesPerDay } = disease;

      let html = `
        دوز انتخاب‌شده برای این بیماری:<br />
        <strong>${toPersianDigits(mgPerKgPerDay)} میلی‌گرم بر کیلوگرم در روز</strong><br />
        تعداد نوبت: <strong>${toPersianDigits(dosesPerDay)} بار در روز</strong>
      `;
      if (extraNote) {
        html += `<br /><span style="font-size:12px; opacity:0.85;">${extraNote}</span>`;
      }

      doseInfo.innerHTML = html;
      doseInfoWrapper.classList.remove("hidden");
    });

    /************************************************************
     * محاسبه دوز (وزن‌محور)
     ************************************************************/
    calcBtn.addEventListener("click", () => {
      const weight = parseFloat(weightInput.value);
      if (!weight || weight <= 0) {
        alert("لطفاً وزن معتبر وارد کنید.");
        return;
      }

      const drug = findDrugById(drugSelect.value);
      if (!drug) {
        alert("لطفاً ابتدا دارو را انتخاب کنید.");
        return;
      }

      const strength = findStrength(drug, strengthSelect.value);
      if (!strength) {
        alert("لطفاً غلظت شربت را انتخاب کنید.");
        return;
      }

      const disease = findDisease(drug, diseaseSelect.value);
      if (!disease) {
        alert("لطفاً بیماری / اندیکاسیون را انتخاب کنید.");
        return;
      }

      const mgPerKgPerDay = disease.mgPerKgPerDay;
      const dosesPerDay = disease.dosesPerDay;
      const days = disease.days;
      const mgPer5ml = strength.mgPer5ml;

      // حالت خاص آزیترومایسین ۵ روزه
      if (drug.id === "azithromycin" && disease.id === "azi_5day") {
        const totalDay1 = weight * 10;
        const totalNext = weight * 5;
        const mlDay1 = totalDay1 * (5 / mgPer5ml);
        const mlNext = totalNext * (5 / mgPer5ml);

        const html = `
          برای کودک با وزن <strong>${toPersianDigits(weight.toFixed(1))} کیلوگرم</strong>:<br /><br />
          <strong>روز اول:</strong><br />
          • دوز: <strong>${toPersianDigits(totalDay1.toFixed(1))} میلی‌گرم</strong> (۱۰ میلی‌گرم بر کیلوگرم)<br />
          • حجم: <strong class="highlight-dose">${toPersianDigits(mlDay1.toFixed(1))} میلی‌لیتر</strong> یک‌بار در روز<br /><br />
          <strong>روزهای ۲ تا ۵:</strong><br />
          • دوز هر روز: <strong>${toPersianDigits(totalNext.toFixed(1))} میلی‌گرم</strong> (۵ میلی‌گرم بر کیلوگرم)<br />
          • حجم هر روز: <strong class="highlight-dose">${toPersianDigits(mlNext.toFixed(1))} میلی‌لیتر</strong> یک‌بار در روز<br /><br />
          • تعداد روزهای درمان: <strong>${toPersianDigits(days)}</strong> روز
        `;
        resultDiv.innerHTML = html;
        resultDiv.classList.remove("hidden");
        return;
      }

      // حالت عمومی
      const totalMgPerDay = weight * mgPerKgPerDay;
      const mgPerDose = totalMgPerDay / dosesPerDay;
      const mlPerDose = mgPerDose * (5 / mgPer5ml);
      const intervalHours = (24 / dosesPerDay).toFixed(1);

      let html = `
        برای کودک با وزن <strong>${toPersianDigits(weight.toFixed(1))} کیلوگرم</strong>:<br /><br />
        • دوز روزانهٔ کل: <strong>${toPersianDigits(totalMgPerDay.toFixed(1))} میلی‌گرم در روز</strong><br />
        • دوز هر نوبت: <strong>${toPersianDigits(mgPerDose.toFixed(1))} میلی‌گرم در هر نوبت</strong><br />
        • حجم هر نوبت شربت: <strong class="highlight-dose">${toPersianDigits(mlPerDose.toFixed(1))} میلی‌لیتر</strong><br />
        • تعداد نوبت در روز: <strong>${toPersianDigits(dosesPerDay)}</strong> بار در روز<br />
        • فاصلهٔ بین نوبت‌ها: <strong class="highlight-dose">${toPersianDigits(intervalHours)} ساعت</strong><br />
        • مدت درمان تقریبی: <strong>${toPersianDigits(days)}</strong> روز
      `;

      // بررسی سمی بودن دوز بر اساس حداکثر مجاز
      if (disease.maxMgPerKgPerDay) {
        const maxTotal = disease.maxMgPerKgPerDay * weight;
        if (totalMgPerDay > maxTotal) {
          html += `<br /><br /><span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--warning-color')};"><strong>⚠️ هشدار:</strong> دوز محاسبه‌شده (${toPersianDigits(totalMgPerDay.toFixed(1))} میلی‌گرم در روز) از حداکثر مجاز (${toPersianDigits(maxTotal.toFixed(1))} میلی‌گرم در روز) برای این دارو تجاوز کرده است. لطفاً دوز را بررسی کنید.</span>`;
        }
      }

      resultDiv.innerHTML = html;
      resultDiv.classList.remove("hidden");
    });

    /************************************************************
     * شروع مجدد (وزن‌محور)
     ************************************************************/
    resetBtn.addEventListener("click", () => {
      weightInput.value = "";
      drugSelect.value = "";
      strengthSelect.innerHTML = "";
      diseaseSelect.innerHTML = "";
      strengthWrapper.classList.add("hidden");
      diseaseWrapper.classList.add("hidden");
      drugNotesWrapper.classList.add("hidden");
      doseInfoWrapper.classList.add("hidden");
      resultDiv.classList.add("hidden");
      drugNotes.textContent = "";
      doseInfo.innerHTML = "";
      resultDiv.innerHTML = "";
    });

    /************************************************************
     * تغییر دارو (سن‌محور)
     ************************************************************/
    ageDrugSelect.addEventListener("change", () => {
      const drug = findAgeDrugById(ageDrugSelect.value);

      ageStrengthSelect.innerHTML = "";
      ageStrengthWrapper.classList.add("hidden");
      ageDrugNotesWrapper.classList.add("hidden");
      ageDoseInfoWrapper.classList.add("hidden");
      ageResultDiv.classList.add("hidden");
      ageDrugNotes.textContent = "";
      ageDoseInfo.innerHTML = "";

      if (!drug) return;

      ageDrugNotes.textContent = drug.notes || "نکته‌ای ثبت نشده است.";
      ageDrugNotesWrapper.classList.remove("hidden");

      if (drug.strengths?.length) {
        drug.strengths.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = s.label;
          ageStrengthSelect.appendChild(opt);
        });
        ageStrengthWrapper.classList.remove("hidden");
      }

      updateAgeDoseInfo();
    });

    /************************************************************
     * نمایش دوز بر اساس سن
     ************************************************************/
    function getAgeBand(drug, ageYears) {
      if (!drug?.ageBands) return null;
      return drug.ageBands.find(b =>
        ageYears >= b.minAge && (b.maxAge == null || ageYears < b.maxAge)
      ) || null;
    }

    function updateAgeDoseInfo() {
      const ageYears = parseFloat(ageYearsInput.value);
      const drug = findAgeDrugById(ageDrugSelect.value);

      if (!drug || !Number.isFinite(ageYears) || ageYears <= 0) {
        ageDoseInfoWrapper.classList.add("hidden");
        ageDoseInfo.innerHTML = "";
        return;
      }

      const band = getAgeBand(drug, ageYears);
      if (!band) {
        ageDoseInfoWrapper.classList.add("hidden");
        ageDoseInfo.innerHTML = "";
        return;
      }

      const { mgPerDay, dosesPerDay, label, note } = band;
      let html = `
        بازهٔ سنی: <strong>${label}</strong><br />
        دوز روزانه: <strong>${toPersianDigits(mgPerDay)} میلی‌گرم در روز</strong><br />
        تعداد نوبت در روز: <strong>${toPersianDigits(dosesPerDay)}</strong>
      `;
      if (note) {
        html += `<br /><span style="font-size:12px; opacity:0.85;">${note}</span>`;
      }
      ageDoseInfo.innerHTML = html;
      ageDoseInfoWrapper.classList.remove("hidden");
    }

    ageYearsInput.addEventListener("input", updateAgeDoseInfo);
    ageDrugSelect.addEventListener("change", updateAgeDoseInfo);

    /************************************************************
     * محاسبه دوز (سن‌محور)
     ************************************************************/
    ageCalcBtn.addEventListener("click", () => {
      const ageYears = parseFloat(ageYearsInput.value);
      if (!Number.isFinite(ageYears) || ageYears <= 0) {
        alert("لطفاً سن معتبر وارد کنید.");
        return;
      }

      const drug = findAgeDrugById(ageDrugSelect.value);
      if (!drug) {
        alert("لطفاً داروی آنتی‌هیستامین را انتخاب کنید.");
        return;
      }

      const strength = drug.strengths.find(s => s.id === ageStrengthSelect.value);
      if (!strength) {
        alert("لطفاً غلظت شربت را انتخاب کنید.");
        return;
      }

      const band = getAgeBand(drug, ageYears);
      if (!band) {
        alert("برای این سن دوزی ثبت نشده است.");
        return;
      }

      const { mgPerDay, dosesPerDay, label } = band;
      const mgPerDose = mgPerDay / dosesPerDay;
      const mlPerDose = mgPerDose * (5 / strength.mgPer5ml);
      const intervalHours = (24 / dosesPerDay).toFixed(1);

      const html = `
        سن کودک: <strong>${toPersianDigits(ageYears.toFixed(1))} سال</strong><br />
        بازهٔ سنی دوز: <strong>${label}</strong><br /><br />
        • دوز روزانهٔ کل: <strong>${toPersianDigits(mgPerDay)} میلی‌گرم در روز</strong><br />
        • دوز هر نوبت: <strong>${toPersianDigits(mgPerDose.toFixed(1))} میلی‌گرم در هر نوبت</strong><br />
        • حجم هر نوبت شربت: <strong class="highlight-dose">${toPersianDigits(mlPerDose.toFixed(1))} میلی‌لیتر</strong><br />
        • تعداد نوبت در روز: <strong>${toPersianDigits(dosesPerDay)}</strong><br />
        • فاصلهٔ بین نوبت‌ها: <strong class="highlight-dose">${toPersianDigits(intervalHours)} ساعت</strong><br />
        • مدت مصرف: بر اساس نوع آلرژی و پاسخ بیمار تنظیم می‌شود.
      `;
      ageResultDiv.innerHTML = html;
      ageResultDiv.classList.remove("hidden");
      updateAgeDoseInfo();
    });

    /************************************************************
     * تم روز/شب
     ************************************************************/
    function applyTheme(theme) {
      document.body.setAttribute("data-theme", theme);
      themeSwitch.checked = theme === "dark";
      themeIcon.textContent = theme === "dark" ? "🌙" : "☀️";
    }

    (function initTheme() {
      const saved = localStorage.getItem("theme");
      if (saved === "dark" || saved === "light") {
        applyTheme(saved);
      } else if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
        applyTheme("dark");
      } else {
        applyTheme("light");
      }
    })();

    themeSwitch.addEventListener("change", () => {
      const theme = themeSwitch.checked ? "dark" : "light";
      applyTheme(theme);
      localStorage.setItem("theme", theme);
    });

    /************************************************************
     * اجرا در شروع
     ************************************************************/
    populateDrugs();
    populateAgeDrugs();

    /************************************************************
     * افکت حروف چرخان در پس‌زمینه
     ************************************************************/
    const canvasBg = document.getElementById("sceneBg");
    const ctxBg = canvasBg.getContext("2d");
    const textCanvas = document.createElement("canvas");
    const textCtx = textCanvas.getContext("2d");
    const heroElement = document.querySelector(".hero");

    let W = window.innerWidth;
    let H = window.innerHeight;

    canvasBg.width = W;
    canvasBg.height = H;
    textCanvas.width = W;
    textCanvas.height = H;

    const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
    let textPoints = [];
    let particles = [];

    const CHAOS_DURATION = 4000;
    const FORM_DURATION = 4000;
    const HOLD_DURATION = 2000;
    const DISSOLVE_DURATION = 4000;
    const TOTAL_DURATION = CHAOS_DURATION + FORM_DURATION + HOLD_DURATION + DISSOLVE_DURATION;

    let startTime = performance.now();
    let lastPhase = null;

    function buildTextPoints() {
      W = window.innerWidth;
      H = window.innerHeight;

      canvasBg.width = W;
      canvasBg.height = H;
      textCanvas.width = W;
      textCanvas.height = H;

      textCtx.clearRect(0, 0, W, H);

      const heroRect = heroElement.getBoundingClientRect();
      const centerX = heroRect.left + heroRect.width / 2;
      const centerY = heroRect.top + heroRect.height / 2;
      const fontSize = heroRect.height * 0.6;

      textCtx.font = `bold ${fontSize}px system-ui, sans-serif`;
      textCtx.textAlign = "center";
      textCtx.textBaseline = "middle";
      textCtx.fillStyle = "#ffffff";

      const text = "Saphira";
      textCtx.fillText(text, centerX, centerY);

      const imageData = textCtx.getImageData(0, 0, W, H).data;
      const points = [];
      const step = 6;

      for (let y = 0; y < H; y += step) {
        for (let x = 0; x < W; x += step) {
          const index = (y * W + x) * 4 + 3;
          const alpha = imageData[index];
          if (alpha > 128) {
            points.push({ x, y });
          }
        }
      }
      textPoints = points;
    }

    function initParticles() {
      particles = [];
      if (!textPoints.length) return;

      const maxParticles = Math.min(1400, textPoints.length * 2);
      for (let i = 0; i < maxParticles; i++) {
        const startX = Math.random() * W;
        const startY = Math.random() * H;
        const speed = 0.5 + Math.random() * 1.5;
        const angle = Math.random() * Math.PI * 2;
        const tp = textPoints[i % textPoints.length];

        particles.push({
          char: LETTERS[Math.floor(Math.random() * LETTERS.length)],
          x: startX,
          y: startY,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          homeX: tp.x,
          homeY: tp.y,
          wanderX: startX,
          wanderY: startY,
          size: 10 + Math.random() * 6,
          phaseOffset: Math.random() * Math.PI * 2
        });
      }
    }

    function resetChaosVelocities() {
      for (const p of particles) {
        const speed = 0.5 + Math.random() * 1.4;
        const angle = Math.random() * Math.PI * 2;
        p.vx = Math.cos(angle) * speed;
        p.vy = Math.sin(angle) * speed;
      }
    }

    function assignDissolveTargets() {
      for (const p of particles) {
        p.wanderX = Math.random() * W;
        p.wanderY = Math.random() * H;
      }
    }

    function getPhase(time) {
      const t = (time - startTime) % TOTAL_DURATION;
      if (t < CHAOS_DURATION) {
        return { name: "chaos", localT: t / CHAOS_DURATION };
      } else if (t < CHAOS_DURATION + FORM_DURATION) {
        return { name: "forming", localT: (t - CHAOS_DURATION) / FORM_DURATION };
      } else if (t < CHAOS_DURATION + FORM_DURATION + HOLD_DURATION) {
        return { name: "hold", localT: (t - CHAOS_DURATION - FORM_DURATION) / HOLD_DURATION };
      } else {
        return { name: "dissolve", localT: (t - CHAOS_DURATION - FORM_DURATION - HOLD_DURATION) / DISSOLVE_DURATION };
      }
    }

    function updateParticles(now, phaseInfo) {
      const { name: phaseName, localT } = phaseInfo;
      const t = localT;
      const timeFactor = now * 0.001;

      for (const p of particles) {
        if (phaseName === "chaos") {
          p.x += p.vx;
          p.y += p.vy;
          const swirlStrength = 0.8;
          p.x += Math.cos(p.phaseOffset + timeFactor * 2.0) * swirlStrength;
          p.y += Math.sin(p.phaseOffset + timeFactor * 2.0) * swirlStrength;
          if (p.x < -20) p.x = W + 20;
          if (p.x > W + 20) p.x = -20;
          if (p.y < -20) p.y = H + 20;
          if (p.y > H + 20) p.y = -20;
        } else if (phaseName === "forming" || phaseName === "hold") {
          const towardStrength = phaseName === "forming" ? (0.04 + t * 0.08) : 0.18;
          p.x += (p.homeX - p.x) * towardStrength;
          p.y += (p.homeY - p.y) * towardStrength;
          const swirlStrength = phaseName === "forming" ? (1.5 * (1 - t)) : 0.3;
          p.x += Math.cos(p.phaseOffset + timeFactor * 3.0) * swirlStrength;
          p.y += Math.sin(p.phaseOffset + timeFactor * 3.0) * swirlStrength;
        } else {
          const ease = t * t * (3 - 2 * t);
          const awayStrength = 0.08 + ease * 0.12;
          p.x += (p.wanderX - p.x) * awayStrength;
          p.y += (p.wanderY - p.y) * awayStrength;
          const swirlStrength = 1.3 + t * 1.2;
          p.x += Math.cos(p.phaseOffset + timeFactor * 3.5) * swirlStrength;
          p.y += Math.sin(p.phaseOffset + timeFactor * 3.5) * swirlStrength;
        }
      }
    }

    function drawParticles(now, phaseInfo) {
      const { name: phaseName, localT } = phaseInfo;
      const t = localT;
      const isDark = document.body.getAttribute("data-theme") === "dark";

      ctxBg.clearRect(0, 0, W, H);
      ctxBg.save();

      ctxBg.globalCompositeOperation = "source-over";
      ctxBg.fillStyle = isDark ? "rgba(0,0,0,0.28)" : "rgba(255,255,255,0.22)";
      ctxBg.fillRect(0, 0, W, H);

      ctxBg.globalCompositeOperation = isDark ? "lighter" : "source-over";

      for (const p of particles) {
        let alpha;
        if (phaseName === "chaos") {
          alpha = isDark ? 0.35 : 0.3;
        } else if (phaseName === "forming") {
          alpha = 0.4 + 0.5 * t;
        } else if (phaseName === "hold") {
          alpha = 0.9;
        } else {
          alpha = 0.9 - 0.6 * t;
        }

        ctxBg.save();
        ctxBg.globalAlpha = alpha;

        const hueOffset = (p.phaseOffset * 180 / Math.PI + now * 0.01) % 360;
        const baseHue = isDark ? 190 : 210;
        const hue = baseHue + 0.4 * hueOffset;
        const sat = isDark ? 80 : 65;
        const light = isDark ? 70 : 45;

        ctxBg.fillStyle = `hsl(${hue}, ${sat}%, ${light}%)`;
        ctxBg.font = `${p.size}px "JetBrains Mono", "SF Mono", Menlo, Consolas, monospace`;
        ctxBg.fillText(p.char, p.x, p.y);
        ctxBg.restore();
      }

      ctxBg.restore();
    }

    function animationLoop(now) {
      const phaseInfo = getPhase(now);

      if (phaseInfo.name !== lastPhase) {
        if (phaseInfo.name === "chaos") {
          resetChaosVelocities();
        } else if (phaseInfo.name === "dissolve") {
          assignDissolveTargets();
        }
        lastPhase = phaseInfo.name;
      }

      updateParticles(now, phaseInfo);
      drawParticles(now, phaseInfo);

      requestAnimationFrame(animationLoop);
    }

    function handleResize() {
      W = window.innerWidth;
      H = window.innerHeight;
      canvasBg.width = W;
      canvasBg.height = H;
      buildTextPoints();
      initParticles();
      resetChaosVelocities();
    }

    window.addEventListener("resize", handleResize);

    buildTextPoints();
    initParticles();
    resetChaosVelocities();
    requestAnimationFrame(animationLoop);
  </script>
</body>
</html>
